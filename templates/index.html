<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Cleaner</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>

<header>
    <div>
        <h1><span>MIDI</span> <span data-i18n="title">Cleaner</span></h1>
        <div class="subtitle" data-i18n="subtitle">Clean multi-track MIDI files from AI transcription artifacts</div>
    </div>
    <button id="lang-toggle" class="btn-lang" title="Switch language">RU</button>
</header>

<main>
    <!-- Upload Zone -->
    <section>
        <div class="drop-zone" id="drop-zone">
            <div class="icon">&#128196;</div>
            <p data-i18n="drop_zone">Drop MIDI file here or click to browse</p>
            <input type="file" accept=".mid,.midi">
        </div>
    </section>

    <!-- File Info -->
    <div class="file-info"></div>

    <!-- Full Player -->
    <section class="player-section" id="player-section">
        <h2 data-i18n="player_title">Player</h2>
        <div class="player-bar">
            <div class="player-controls">
                <button id="player-rewind" class="player-btn" title="Rewind">&#9198;</button>
                <button id="player-play" class="player-btn play-btn" title="Play">&#9654;</button>
                <button id="player-pause" class="player-btn" title="Pause" style="display:none">&#9646;&#9646;</button>
                <button id="player-stop" class="player-btn" title="Stop">&#9632;</button>
            </div>
            <div class="player-timeline">
                <input type="range" id="player-seek" min="0" max="1000" value="0" step="1">
                <div class="player-time">
                    <span id="player-current">0:00</span> / <span id="player-total">0:00</span>
                </div>
            </div>
            <div class="player-source-toggle">
                <button id="player-src-original" class="player-src-btn active" data-i18n="original">Original</button>
                <button id="player-src-processed" class="player-src-btn" data-i18n="processed" disabled>Processed</button>
            </div>
        </div>
    </section>

    <!-- Global Configuration -->
    <section class="config-panel">
        <h2 data-i18n="processing_settings">Processing Settings</h2>
        <div class="config-grid">
            <div class="config-item">
                <label for="cfg-tempo-dedup">
                    <span data-i18n="tempo_dedup">Deduplicate Tempo</span>
                    <span class="desc" data-i18n="tempo_dedup_desc">Remove redundant tempo markings (fixes ♩=91 spam)</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-tempo-dedup" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label for="cfg-merge-voices">
                    <span data-i18n="merge_voices">Merge Voices</span>
                    <span class="desc" data-i18n="merge_voices_desc">Consolidate all voices to voice 1 per track</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-merge-voices" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label for="cfg-remove-overlaps">
                    <span data-i18n="remove_overlaps">Remove Overlaps</span>
                    <span class="desc" data-i18n="remove_overlaps_desc">Merge overlapping same-pitch notes</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-remove-overlaps" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label for="cfg-remove-triplets">
                    <span data-i18n="remove_triplets">Remove Triplets</span>
                    <span class="desc" data-i18n="remove_triplets_desc">Convert triplet notes to straight eighths</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-remove-triplets" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="triplet_tolerance">Triplet Tolerance</span>
                    <span class="desc" data-i18n="triplet_tolerance_desc">Detection sensitivity (0.05=strict, 0.25=loose)</span>
                </label>
                <div class="range-group">
                    <input type="range" id="cfg-triplet-tolerance" min="0.05" max="0.30" step="0.01" value="0.15">
                    <span class="value">0.15</span>
                </div>
            </div>
            <div class="config-item">
                <label for="cfg-quantize">
                    <span data-i18n="quantize">Quantize</span>
                    <span class="desc" data-i18n="quantize_desc">Snap note timing to rhythmic grid</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-quantize" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label for="cfg-quantize-grid">
                    <span data-i18n="grid_resolution">Grid Resolution</span>
                    <span class="desc" data-i18n="grid_resolution_desc">Quantization grid size</span>
                </label>
                <select id="cfg-quantize-grid">
                    <option value="quarter" data-i18n-opt="quarter">Quarter note</option>
                    <option value="eighth" selected data-i18n-opt="eighth">Eighth note</option>
                    <option value="sixteenth" data-i18n-opt="sixteenth">Sixteenth note</option>
                </select>
            </div>
            <div class="config-item">
                <label for="cfg-remove-cc">
                    <span data-i18n="remove_cc">Remove CC Messages</span>
                    <span class="desc" data-i18n="remove_cc_desc">Strip control change messages</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-remove-cc" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="cc_to_remove">CC Numbers to Remove</span>
                    <span class="desc" data-i18n="cc_to_remove_desc">Select which CC to strip</span>
                </label>
                <div style="display:flex;gap:12px;align-items:center">
                    <label style="font-size:12px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="cfg-cc-64" checked> CC#64 (Sustain)</label>
                    <label style="font-size:12px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="cfg-cc-68" checked> CC#68 (Legato)</label>
                </div>
            </div>
            <div class="config-item">
                <label for="cfg-pitch-cluster">
                    <span data-i18n="pitch_cluster">Pitch Cluster</span>
                    <span class="desc" data-i18n="pitch_cluster_desc">Merge near-pitch simultaneous notes (AI transcription noise)</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-pitch-cluster" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="pitch_cluster_window">Time Window (ticks)</span>
                    <span class="desc" data-i18n="pitch_cluster_window_desc">Max onset spread for notes to be considered simultaneous</span>
                </label>
                <div class="range-group">
                    <input type="range" id="cfg-pitch-cluster-window" min="0" max="120" step="5" value="20">
                    <span class="value">20</span>
                </div>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="pitch_cluster_threshold">Pitch Threshold (semitones)</span>
                    <span class="desc" data-i18n="pitch_cluster_threshold_desc">Max semitone distance within a cluster</span>
                </label>
                <div class="range-group">
                    <input type="range" id="cfg-pitch-cluster-threshold" min="0" max="3" step="1" value="1">
                    <span class="value">1</span>
                </div>
            </div>
            <div class="config-item">
                <label for="cfg-filter-noise">
                    <span data-i18n="noise_filter">Noise Filter</span>
                    <span class="desc" data-i18n="noise_filter_desc">Remove short and quiet parasitic notes</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-filter-noise" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="min_duration">Min Note Duration (ticks)</span>
                    <span class="desc" data-i18n="min_duration_desc">Notes shorter than this are removed</span>
                </label>
                <div class="range-group">
                    <input type="range" id="cfg-min-duration" min="0" max="480" step="10" value="120">
                    <span class="value">120</span>
                </div>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="min_velocity">Min Velocity</span>
                    <span class="desc" data-i18n="min_velocity_desc">Notes quieter than this are removed</span>
                </label>
                <div class="range-group">
                    <input type="range" id="cfg-min-velocity" min="0" max="127" step="1" value="20">
                    <span class="value">20</span>
                </div>
            </div>
            <div class="config-item">
                <label for="cfg-same-pitch-overlap">
                    <span data-i18n="same_pitch_overlap">Same-Pitch Overlap Resolver</span>
                    <span class="desc" data-i18n="same_pitch_overlap_desc">Remove duplicate overlapping notes of the same pitch per channel</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-same-pitch-overlap" checked><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="start_bar">Start Processing from Bar</span>
                    <span class="desc" data-i18n="start_bar_desc">Skip already-cleaned bars (1 = process everything)</span>
                </label>
                <input type="number" id="cfg-start-bar" min="1" max="999" value="1">
            </div>
            <div class="config-item">
                <label for="cfg-merge-tracks">
                    <span data-i18n="merge_tracks">Merge All Tracks</span>
                    <span class="desc" data-i18n="merge_tracks_desc">Flatten into a single track (Type 0) for manual editing</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-merge-tracks"><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label for="cfg-merge-cc">
                    <span data-i18n="merge_tracks_cc">Include CC in Merge</span>
                    <span class="desc" data-i18n="merge_tracks_cc_desc">Keep CC events in the merged output</span>
                </label>
                <label class="toggle"><input type="checkbox" id="cfg-merge-cc"><span class="slider"></span></label>
            </div>
            <div class="config-item">
                <label>
                    <span data-i18n="merge_cc_whitelist">Merge CC Whitelist</span>
                    <span class="desc" data-i18n="merge_cc_whitelist_desc">Which CC numbers to keep (uncheck all = keep all)</span>
                </label>
                <div style="display:flex;gap:12px;align-items:center">
                    <label style="font-size:12px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="cfg-merge-cc-64" checked> CC#64</label>
                    <label style="font-size:12px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="cfg-merge-cc-68" checked> CC#68</label>
                </div>
            </div>
        </div>
    </section>

    <!-- Auto Optimize Panel -->
    <section class="optimize-panel" id="optimize-panel">
        <h2 data-i18n="auto_optimize">Auto Optimize</h2>
        <div class="optimize-body">
            <div class="optimize-controls">
                <div class="config-item">
                    <label>
                        <span data-i18n="opt_max_trials">Max Trials</span>
                        <span class="desc" data-i18n="opt_max_trials_desc">Maximum optimization iterations (1–100)</span>
                    </label>
                    <input type="number" id="opt-max-trials" min="1" max="100" value="40">
                </div>
                <button id="btn-optimize" class="btn btn-primary" style="margin-top:8px">
                    &#9881; <span data-i18n="opt_start">Start Optimization</span>
                </button>
            </div>
            <div class="optimize-status" id="optimize-status" style="display:none">
                <div class="optimize-progress">
                    <div class="optimize-stat">
                        <span class="optimize-label" data-i18n="opt_trial">Trial</span>
                        <span class="optimize-value" id="opt-trial">0 / 40</span>
                    </div>
                    <div class="optimize-stat">
                        <span class="optimize-label" data-i18n="opt_best_score">Best Score</span>
                        <span class="optimize-value" id="opt-best-score">&mdash;</span>
                    </div>
                    <div class="optimize-stat">
                        <span class="optimize-label" data-i18n="opt_track_type">Track Type</span>
                        <span class="optimize-value" id="opt-track-type">&mdash;</span>
                    </div>
                    <div class="optimize-stat">
                        <span class="optimize-label" data-i18n="opt_status_label">Status</span>
                        <span class="optimize-value" id="opt-status-text">
                            <div class="spinner" style="display:inline-block;vertical-align:middle"></div>
                            <span data-i18n="opt_running">Running...</span>
                        </span>
                    </div>
                </div>
                <div class="optimize-params" id="optimize-params">
                    <h3 data-i18n="opt_current_params">Current Best Parameters</h3>
                    <pre id="opt-params-json">{}</pre>
                </div>
                <div class="optimize-done-actions" id="optimize-done-actions" style="display:none">
                    <button id="btn-apply-optimized" class="btn btn-success">
                        &#10004; <span data-i18n="opt_apply">Apply Best Parameters</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Tracks List -->
    <section class="tracks-list"></section>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="status"></div>
        <div style="display:flex;gap:8px;align-items:center">
            <button id="btn-download" class="btn btn-success" style="display:none">&#11015; <span data-i18n="download_btn">Download</span></button>
            <button id="btn-process" class="btn btn-primary">&#9881; <span data-i18n="process_btn">Process &amp; Clean</span></button>
        </div>
    </div>
</main>

<div class="toast-container"></div>

<script src="/static/js/app.js"></script>
</body>
</html>
